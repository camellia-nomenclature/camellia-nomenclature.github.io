<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camellia Lookup</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∫</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Georgia', serif;
      background: #f5f0eb;
      color: #2c2c2c;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #2d5016 0%, #4a7c28 100%);
      padding: 2rem;
      text-align: center;
      color: white;
    }
    .header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      letter-spacing: 1px;
    }
    .header p {
      opacity: 0.85;
      font-size: 0.95rem;
    }
    .search-container {
      max-width: 480px;
      margin: -1.5rem auto 0.3rem;
      padding: 0 1rem;
      position: relative;
    }
    #search {
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      outline: none;
      font-family: inherit;
    }
    #search:focus {
      box-shadow: 0 4px 20px rgba(45,80,22,0.3);
    }
    #search { padding-right: 2.5rem; }
    #search::placeholder { color: #aaa; }
    .clear-btn {
      position: absolute;
      right: 1.8rem;
      top: 50%;
      transform: translateY(-50%);
      background: #ccc;
      border: none;
      color: #fff;
      font-size: 1rem;
      width: 1.6rem;
      height: 1.6rem;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      line-height: 1;
      padding: 0;
      z-index: 2;
    }
    .clear-btn:hover { background: #999; }
    .dropdown {
      position: absolute;
      top: 100%;
      left: 1rem;
      right: 1rem;
      background: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      max-height: 350px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    .dropdown.active { display: block; }
    .dropdown-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-item:hover, .dropdown-item.selected {
      background: #f0f7e8;
    }
    .dropdown-item .name { font-weight: bold; }
    .dropdown-item .species { color: #6a8a4a; font-size: 0.85rem; }
    .stats {
      text-align: center;
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 1.5rem;
    }
    .results {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1rem 2rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .card-header {
      background: linear-gradient(135deg, #2d5016, #4a7c28);
      color: white;
      padding: 1rem 1.5rem;
    }
    .card-header h2 {
      font-size: 1.4rem;
      letter-spacing: 0.5px;
    }
    .card-body {
      padding: 1.25rem 1.5rem;
      display: flex;
      gap: 1.5rem;
    }
    .card-info { flex: 1; min-width: 0; }
    .card-image {
      width: 200px;
      height: 200px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .card-image img {
      width: 200px;
      height: 200px;
      object-fit: cover;
    }
    .card-image .no-image {
      width: 100%;
      height: 100%;
      min-height: 150px;
      background: #e8e0d8;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 0.85rem;
      text-align: center;
      padding: 1rem;
    }
    /* Mobile responsive */
    @media (max-width: 600px) {
      .header { padding: 1.2rem 1rem; }
      .header h1 { font-size: 1.8rem; }
      .search-container { margin-top: -1rem; }
      #search { font-size: 1.5rem; padding: 1.1rem 1.3rem; padding-right: 3rem; }
      .clear-btn { right: 1.5rem; width: 2rem; height: 2rem; font-size: 1.2rem; }
      .dropdown .item { font-size: 1.1rem; padding: 0.7rem 1rem; }
      .search-tip { font-size: 1.1rem !important; }
      .home-flower { font-size: 5rem !important; }
      .card-body {
        flex-direction: column;
      }
      .card-image {
        width: 100%;
        height: auto;
        aspect-ratio: 1;
        order: 1;
      }
      .card-info {
        order: 0;
      }
      .card-image img {
        width: 100%;
        height: 100%;
      }
      .info-value { font-size: 0.9rem; }
      .card-header h2 { font-size: 1.2rem; }
    }
    .info-row {
      padding: 0.6rem 0;
      border-bottom: 1px solid #f0ece8;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6a8a4a;
      font-weight: bold;
      margin-bottom: 0.2rem;
    }
    .info-value {
      font-size: 1rem;
      line-height: 1.5;
      word-break: break-word;
    }
    .info-value a {
      word-break: break-all;
    }
    .spinner {
      width: 24px; height: 24px;
      border: 3px solid #ddd;
      border-top-color: #6a8a4a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state {
      text-align: center;
      padding: 4rem 1rem;
      color: #aaa;
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state p { font-size: 1.1rem; }

  </style>
</head>
<body>
  <div class="header">
    <h1><a href="/" onclick="document.getElementById('search').value='';document.getElementById('search').dispatchEvent(new Event('input'));document.getElementById('results').innerHTML='';document.getElementById('searchHints').style.display='';document.getElementById('homeSection').style.display='';history.replaceState(null,'',location.pathname);return false;" style="text-decoration:none;color:inherit;cursor:pointer;"><span style="font-size:1.5em">üå∫</span> Camellia Nomenclature</a></h1>
  </div>

  <div class="search-container">
    <input type="text" id="search" placeholder="Type a camellia name..." autocomplete="off">
    <button class="clear-btn" id="clearBtn" aria-label="Clear search">‚úï</button>
    <div class="dropdown" id="dropdown"></div>
  </div>

  <div id="searchHints" style="max-width:480px;margin:0.2rem auto 0;padding:0 1rem;color:#666;font-size:0.9rem;">
    ‚Ä¢ Spaces, apostrophes, and capitalization don't matter.<br>
    ‚Ä¢ Just type any part of the name.
  </div>
  <div id="homeSection" style="text-align:center;margin-top:1.5rem;">
    <div class="home-flower" style="font-size:4rem;">üå∏</div>
    <div id="bookTitle" style="color:#666;font-size:0.9rem;margin-top:0.5rem;font-style:italic;">2024 Camellia Nomenclature and Picture Gallery</div>
    <div id="statsLine" style="color:#888;font-size:0.85rem;margin-top:0.4rem;">7,723 camellias indexed across 12 species</div>
  </div>

  <div class="results" id="results">
  </div>

  <script>
    let camellias = [];
    let camelliaNameSet = new Set();
    function linkifyDescription(desc) {
      if (!desc || !camelliaNameSet.size) return desc;

      const linkName = (displayName) => {
        const safeLower = displayName.toLowerCase().replace(/'/g, "\\'");
        return '<a href="#' + encodeURIComponent(displayName) + '" onclick="event.preventDefault();const m=camellias.find(c=>c.name.toLowerCase()===\'' + safeLower + '\');if(m)selectCamellia(m);" style="color:#2d5016;text-decoration:none;cursor:pointer;background:#eee;padding:1px 6px;border-radius:4px;border:1px solid #ddd;font-size:0.95em">' + displayName + '</a>';
      };

      // 1) Standard quoted aliases: 'Alias' or "Alias"
      let out = desc.replace(/['"]([A-Z][^'"]*(?:'(?=[a-z])[^'"]*)*)['"]/g, (match, name) => {
        const trimmed = name.replace(/[\s?.!,]+$/, '');
        const lookupName = (trimmed.length >= 3 && camelliaNameSet.has(trimmed.toLowerCase())) ? trimmed : name;
        if (camelliaNameSet.has(lookupName.toLowerCase())) {
          return match[0] + linkName(lookupName) + match[match.length - 1];
        }
        return match;
      });

      // 2) Fallback for malformed alias lists in parentheses, e.g. (Aloha'; 'Beni-Arejishi; 'Callie')
      out = out.replace(/\(([^()]*;[^()]*)\)/g, (whole, inner) => {
        const parts = inner.split(';');
        const mapped = parts.map(part => {
          const token = part.trim();
          const core = token.replace(/^[\s'"‚Äò‚Äô]+|[\s'"‚Äò‚Äô.,!?]+$/g, '');
          if (!core || core.length < 3) return part;
          if (!camelliaNameSet.has(core.toLowerCase())) return part;
          return part.replace(core, linkName(core));
        });
        return '(' + mapped.join(';') + ')';
      });

      // 3) "See 'Name'." cross-reference fallback (supports missing/mixed quotes)
      out = out.replace(/\bSee\s+['‚Äò"]?([A-Z][A-Za-z0-9 .'-]{1,80})['‚Äô"]?\./g, (whole, refName) => {
        const cleaned = refName.trim().replace(/[\s?.!,]+$/, '');
        if (!camelliaNameSet.has(cleaned.toLowerCase())) return whole;
        return 'See ' + linkName(cleaned) + '.';
      });

      return out;
    }
    const entryCache = {}; // letter -> {name: fullEntry}

    async function loadData() {
      try {
        const resp = await fetch('data/index.json');
        const index = await resp.json();
        camellias = index.map(e => ({ name: e.n || e.name, species: e.s || e.species }));
        camelliaNameSet = new Set(camellias.map(c => c.name.toLowerCase()));
        precomputeNorms();
      } catch (e) {
        console.error('Failed to load data', e);
      }
    }

    async function fetchFullEntry(name) {
      const letter = name[0].toUpperCase();
      if (!entryCache[letter]) {
        try {
          const resp = await fetch(`data/${letter}.json`);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const arr = await resp.json();
          // Support both array and object formats
          if (Array.isArray(arr)) {
            const obj = {};
            arr.forEach(e => { obj[e.name] = e; });
            entryCache[letter] = obj;
          } else {
            entryCache[letter] = arr;
          }
        } catch (e) {
          console.error('fetchFullEntry error:', e);
          return null;
        }
      }
      return entryCache[letter]?.[name] ?? null;
    }

    const search = document.getElementById('search');
    const dropdown = document.getElementById('dropdown');
    const results = document.getElementById('results');
    const clearBtn = document.getElementById('clearBtn');
    let selectedIdx = -1;
    let matches = [];

    function updateClearBtn() { clearBtn.style.display = search.value ? 'block' : 'none'; }
    clearBtn.addEventListener('click', () => {
      search.value = '';
      search.dispatchEvent(new Event('input'));
      search.focus();
      updateClearBtn();
    });

    // Normalize: strip special chars for fuzzy matching
    const normalize = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[\u0027\u2019\-.,()\/&"]/g, '').replace(/\s+/g, ' ').trim();
    const collapse = s => s.replace(/\s+/g, '');

    function precomputeNorms() { camellias.forEach(c => { c._norm = normalize(c.name); c._coll = collapse(c._norm); }); }

    search.addEventListener('input', () => {
      updateClearBtn();
      const raw = search.value.trim().toLowerCase();
      if (raw.length < 1) {
        dropdown.classList.remove('active');
        return;
      }
      const q = normalize(raw);
      const qc = collapse(q);

      // Typeahead: match normalized; use space-collapsed only for longer queries (avoid false positives)
      const useCollapsed = qc.length >= 2 && !q.includes(' ');
      matches = camellias
        .filter(c => c._norm.includes(q) || (useCollapsed && c._coll.startsWith(qc)) || c.name.toLowerCase().includes(raw))
        .sort((a, b) => {
          const aStarts = a._norm.startsWith(q) ? 0 : 1;
          const bStarts = b._norm.startsWith(q) ? 0 : 1;
          return aStarts - bStarts || a.name.localeCompare(b.name);
        })
        .slice(0, 20);

      selectedIdx = -1;
      renderDropdown();
    });

    search.addEventListener('keydown', (e) => {
      if (!matches.length) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIdx = Math.min(selectedIdx + 1, matches.length - 1);
        renderDropdown();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIdx = Math.max(selectedIdx - 1, 0);
        renderDropdown();
      } else if (e.key === 'Enter' && selectedIdx >= 0) {
        e.preventDefault();
        selectCamellia(matches[selectedIdx]);
      }
    });

    function renderDropdown() {
      if (!matches.length) {
        dropdown.classList.remove('active');
        return;
      }
      dropdown.innerHTML = matches.map((c, i) =>
        `<div class="dropdown-item ${i === selectedIdx ? 'selected' : ''}" data-index="${i}">
          <div class="name">${highlight(c.name, search.value)}</div>
          <div class="species">${c.species}</div>
        </div>`
      ).join('');
      dropdown.querySelectorAll('.dropdown-item').forEach(el => {
        el.addEventListener('click', () => selectCamellia(matches[parseInt(el.dataset.index)]));
      });
      dropdown.classList.add('active');
    }

    function highlight(text, query) {
      const idx = text.toLowerCase().indexOf(query.toLowerCase());
      if (idx === -1) return text;
      return text.substring(0, idx) +
        '<mark style="background:#d4edaa;padding:0 1px;border-radius:2px">' +
        text.substring(idx, idx + query.length) + '</mark>' +
        text.substring(idx + query.length);
    }

    async function selectCamellia(c, skipHash) {
      dropdown.classList.remove('active');
      search.value = c.name;
      if (!skipHash) history.pushState({cultivar: c.name}, '', '#' + encodeURIComponent(c.name));
      document.getElementById('searchHints').style.display = 'none';
      document.getElementById('homeSection').style.display = 'none';
      results.innerHTML = '<div class="card"><div class="card-header"><h2>' + c.name + '</h2></div><div class="card-body" style="justify-content:center;padding:2rem;color:#888;">Loading details...</div></div>';

      const savedName = c.name;
      try {
      const full = await fetchFullEntry(c.name);
      if (!full) { results.innerHTML = `<div class="card"><div class="card-header"><h2>${c.name}</h2></div><div class="card-body" style="color:#888;padding:2rem;text-align:center;">Entry not found.</div></div>`; return; }
      c = full;

      // Image URL: use stored image field first, fallback to SoCal pattern
      const imgName = c.name.replace(/'/g, "%27").replace(/ /g, '%20');
      const imgUrl = c.image || `https://www.socalcamelliasociety.org/Camelliae%20Floris%20Bibliotheca/images/${imgName}.jpg`;
      const encodedName = encodeURIComponent(c.name);
      const icrUrl = `https://camellia.iflora.cn/Cutivars/Detail?latin=${encodedName}`;
      // ACS: direct link ‚Äî strip apostrophes, lowercase, hyphens for spaces
      const acsSlug = c.name.toLowerCase().replace(/['']/g, '').replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
      const firstLetter = c.name[0].toLowerCase();
      const acsUrl = `https://www.americancamellias.com/education-and-camellia-care/acs-camellia-encyclopedia/camellias-beginning-with-${firstLetter}/${acsSlug}`;
      // Determine image source from URL
      function getImageSource(url) {
        if (url.includes('atlanticcoastcamellia')) return 'ACCS';
        if (url.includes('iflora')) return 'ICR';
        if (url.includes('socalcamellia')) return 'SoCal';
        if (url.includes('americancamellias')) return 'ACS';
        return 'SoCal';
      }
      const imgSource = getImageSource(imgUrl);
      const hasImage = !!c.image;
      // Lazy load: show placeholder, only display image after fully downloaded
      const imageHtml = hasImage
        ? `<div class="no-image" id="img-placeholder"><div class="spinner"></div><br>Loading photo...</div>`
        : `<div class="no-image">üå∏<br>No photo available</div>`;
      // Start background download after a small delay to prioritize text rendering
      if (hasImage) {
        setTimeout(() => {
          const img = new Image();
          const imgFallback = () => {
            const ph = document.getElementById('img-placeholder');
            if (ph) ph.innerHTML = 'üå∏<br>No photo available';
          };
          const loadTimer = setTimeout(imgFallback, 10000);
          img.onload = () => {
            clearTimeout(loadTimer);
            const ph = document.getElementById('img-placeholder');
            if (ph) {
              img.alt = c.name;
              img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
              ph.replaceWith(img);
            }
            const cap = document.getElementById('img-caption');
            if (cap) cap.style.display = 'block';
          };
          img.onerror = () => {
            clearTimeout(loadTimer);
            imgFallback();
          };
          img.src = imgUrl;
        }, 50);
      }

      results.innerHTML = `
        <div class="card">
          <div class="card-header">
            <div style="display:flex;align-items:center;justify-content:space-between"><div style="display:flex;align-items:center;gap:16px"><button onclick="history.back()" style="background:rgba(255,255,255,0.15);border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:1.1rem;color:white;display:flex;align-items:center;justify-content:center;flex-shrink:0" title="Go back">‚Üê</button><h2 style="margin:0">${c.name}</h2></div><button onclick="var url=location.origin+location.pathname+'#'+encodeURIComponent('${c.name.replace(/'/g,"\\'")}');var t=document.createElement('textarea');t.value=url;t.style.position='fixed';t.style.opacity='0';document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);this.textContent='‚úÖ';this.style.background='rgba(255,255,255,0.45)';var b=this;setTimeout(function(){b.textContent='üîó';b.style.background='rgba(255,255,255,0.15)'},1200)" style="background:rgba(255,255,255,0.15);border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:1.1rem;color:white;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s" title="Copy link">üîó</button></div>
          </div>
          <div class="card-body">
            <div class="card-info">
              <div class="info-row">
                <div class="info-label">Species</div>
                <div class="info-value">${c.species}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Size</div>
                <div class="info-value">${c.size || 'N/A'}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Description</div>
                <div class="info-value">${linkifyDescription(c.description)}</div>
              </div>
              ${c.acs_url ? `<div class="info-row">
                <div class="info-label">ACS Link</div>
                <div class="info-value"><a href="${c.acs_url}" target="_blank" style="color:#2d5016;text-decoration:underline;">View on American Camellia Society</a></div>
              </div>` : ''}
              ${c.icr_url ? `<div class="info-row">
                <div class="info-label">ICR Link</div>
                <div class="info-value"><a href="${c.icr_url}" target="_blank" style="color:#2d5016;text-decoration:underline;">View on International Camellia Register</a></div>
              </div>` : ''}
            </div>
            <div>
              <div class="card-image">${imageHtml}</div>
              <div id="img-caption" style="display:none;text-align:center;font-size:0.8rem;color:#888;margin-top:0.3rem;font-style:italic;">Photo from ${imgSource} database</div>
            </div>
          </div>
        </div>`;
      } catch (err) {
        console.error('selectCamellia error:', err);
        results.innerHTML = `<div class="card"><div class="card-header"><h2>${savedName}</h2></div><div class="card-body" style="color:#c00;padding:2rem;text-align:center;">Failed to load entry. Please try again.</div></div>`;
      }
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        dropdown.classList.remove('active');
      }
    });

    window.addEventListener('popstate', () => {
      const hash = decodeURIComponent(location.hash.slice(1));
      if (hash && camellias.length) {
        const match = camellias.find(c => c.name.toLowerCase() === hash.toLowerCase());
        if (match) selectCamellia(match, true);
      } else {
        // Back to home
        document.getElementById('search').value = '';
        document.getElementById('search').dispatchEvent(new Event('input'));
        results.innerHTML = '';
        document.getElementById('searchHints').style.display = '';
        document.getElementById('homeSection').style.display = '';
      }
    });

    loadData().then(() => {
      const hash = decodeURIComponent(location.hash.slice(1));
      if (hash && camellias.length) {
        const match = camellias.find(c => c.name.toLowerCase() === hash.toLowerCase());
        if (match) selectCamellia(match, true);
      }
    });
  </script>
  <footer style="text-align:center;padding:2rem 1rem;color:#999;font-size:0.85rem;margin-top:2rem;border-top:1px solid #eee;">
    <strong>Disclaimer:</strong> This site is for personal and educational use only.<br>Information is provided as-is without warranty and may not be complete or current.
  </footer>

</body>
</html>
